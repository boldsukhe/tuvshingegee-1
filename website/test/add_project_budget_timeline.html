<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<title>Төсөв оруулах</title>
<style>
body { font-family: Arial, sans-serif; background-color: #f4f6f8; }
h2 { text-align: center; color: #2c3e50; }
form, .table-container { width: 100%; max-width: 100%; margin: 0; padding: 0; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
td, th { border: 1px solid #ddd; padding: 6px; font-size: 11px; }
tr:nth-child(even) { background-color: #f2f2f2; }
tr:hover { background-color: #e1f5fe; }
input, select { width: 100%; height: 100%; border: none; padding: 6px; box-sizing: border-box; font-size: 11px; background-color: transparent; }
.table_buttons { margin-top: 20px; text-align: right; }
.btn { background-color: #3498db; color: white; padding: 6px 12px; font-size: 11px; border: none; cursor: pointer; margin-left: 10px; border-radius: 4px; }
.btn:hover { background-color: #2980b9; }
.select2-container { width: 100% !important; font-size: 11px !important; }
.select2-selection--single { padding: 0 !important; border: none !important; background-color: transparent !important; box-shadow: none !important; display: flex !important; align-items: center !important; font-size: 11px !important; }
.select2-selection__rendered { line-height: normal !important; font-size: 11px !important; }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
</head>
<body>

<div class="table-container">
<h2 id="projectTitle"></h2>
<form id="dataForm">
<input type="hidden" name="projectName" id="projectNameInput" value="">
<table>
<thead>
<tr>
<th>Бүлэг</th>
<th>Ажлын төрөл</th>
<th>Нэгж</th>
<th>Тоо хэмжээ</th>
<th>Нэгж өртөг</th>
<th>Бүгд өртөг</th>
<th>Эхлэх</th>
<th>Дуусах</th>
</tr>
</thead>
<tbody id="tableBody">
<tr>
<td><select name="buleg_id[]" class="select2"></select></td>
<td><input type="text" name="ajliin_turul"></td>
<td><input type="text" name="negj" readonly></td>
<td><input type="number" name="quantity[]" oninput="calculateTotal(this)"></td>
<td><input type="number" name="unit_cost[]" oninput="calculateTotal(this)"></td>
<td><input type="number" name="total_cost[]" readonly></td>
<td><input type="date" name="start_date[]"></td>
<td><input type="date" name="end_date[]"></td>
</tr>
</tbody>
</table>
<div class="table_buttons">
<button type="button" class="btn btn-add" onclick="addRow()">Мөр нэмэх</button>
<button type="submit" class="btn btn-save">Хадгалах</button>
</div>
</form>
</div>

<script>
let groupsCache = [];

// Load project name and title
const urlParams = new URLSearchParams(window.location.search);
const projectName = urlParams.get('projectName') || '';
document.getElementById("projectNameInput").value = projectName;
document.getElementById("projectTitle").textContent = projectName;

// Fetch group options
function fetchGroups() {
    fetch("get_groups.php")
        .then(res => res.json())
        .then(groups => {
            groupsCache = groups;
            document.querySelectorAll('select[name="buleg_id[]"]').forEach(select => fillSelectOptions(select));
        })
        .catch(console.error);
}

// Fill select options
function fillSelectOptions(select) {
    let currentValue = select.value;
    select.innerHTML = '<option value=""></option>';
    groupsCache.forEach(g => {
        let opt = document.createElement("option");
        opt.value = g.text;
        opt.textContent = g.text;
        select.appendChild(opt);
    });
    select.value = currentValue;
    $(select).select2();
}

// Add new row
function addRow() {
    let table = document.getElementById("tableBody");
    let newRow = document.createElement("tr");
    newRow.innerHTML = `
    <td><select name="buleg_id[]" class="select2"></select></td>
    <td><input type="text" name="ajliin_turul"></td>
    <td><input type="text" name="negj" readonly></td>
    <td><input type="number" name="quantity[]" oninput="calculateTotal(this)"></td>
    <td><input type="number" name="unit_cost[]" oninput="calculateTotal(this)"></td>
    <td><input type="number" name="total_cost[]" readonly></td>
    <td><input type="date" name="start_date[]"></td>
    <td><input type="date" name="end_date[]"></td>
    `;
    table.appendChild(newRow);
    fillSelectOptions(newRow.querySelector('select[name="buleg_id[]"]'));
}

// Auto-fill subgroups and propagate ajliin_turul
$(document).on('change', 'select[name="buleg_id[]"]', function() {
    let row = $(this).closest('tr');
    let ajliinTurul = row.find('input[name="ajliin_turul"]').val() || '';
    let buleg_id = $(this).val();
    if (!buleg_id) return;

    fetch("get_ded_buleg_number.php", {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body: "ded_buleg=" + encodeURIComponent(buleg_id)
    })
    .then(res => res.json())
    .then(data => {
        let table = document.getElementById("tableBody");
        data.forEach(item => {
            let newRow = document.createElement("tr");
            newRow.innerHTML = `
                <td>${item.text}</td>
                <td><input type="text" name="ajliin_turul" readonly></td>
                <td><input type="text" name="negj" readonly></td>
                <td><input type="number" name="quantity[]" oninput="calculateTotal(this)"></td>
                <td><input type="number" name="unit_cost[]" oninput="calculateTotal(this)"></td>
                <td><input type="number" name="total_cost[]" readonly></td>
                <td><input type="date" name="start_date[]"></td>
                <td><input type="date" name="end_date[]"></td>
            `;
            newRow.querySelector('input[name="ajliin_turul"]').value = ajliinTurul;
            table.appendChild(newRow);
        });
    })
    .catch(console.error);
});

// Calculate total
function calculateTotal(input) {
    let row = input.closest("tr");
    let qty = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
    let unit = parseFloat(row.querySelector('input[name="unit_cost[]"]').value) || 0;
    row.querySelector('input[name="total_cost[]"]').value = qty && unit ? (qty*unit).toFixed(2) : '';
}

// Form submit
$('#dataForm').on('submit', function(e){
    e.preventDefault();
    let formData = new FormData(this);
    fetch("./save_budget_form.php", {method:"POST", body: formData})
    .then(res=>res.text())
    .then(()=> window.location.href="./new_form_test_1.html")
    .catch(console.error);
});

// Initialize
$(document).ready(function(){
    fetchGroups();
});
</script>
</body>
</html>
